<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar Widget Custom Site Loader</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            /* Prevent scrollbars on the body */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #toolbar {
            background: #f0f0f0;
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            border-bottom: 1px solid #ccc;
            z-index: 1000;
            /* Ensure toolbar is above everything */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
            transition: margin-top 0.3s ease-in-out;
        }



        #toolbar-notch {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 20px;
            background: #f0f0f0;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            border: 1px solid #ccc;
            border-top: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            font-size: 10px;
            color: #555;
            user-select: none;
        }

        #toolbar-notch:hover {
            background-color: #e0e0e0;
        }

        .toolbar-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #url-group {
            flex-grow: 1;
        }

        #urlInput {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            min-width: 50px;
        }

        select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            width: 150px;
            /* Default width on desktop */
        }

        #loadBtn {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            white-space: nowrap;
        }

        #loadBtn:hover {
            background-color: #0056b3;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 600px) {
            #toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .toolbar-group {
                width: 100%;
            }

            /* #select-group inherits .toolbar-group styles (width: 100%) */

            select {
                flex: 1;
                /* Grow to fill space */
                width: 0;
                /* Allow shrinking below content size if needed */
                min-width: 0;
                /* Allow flex shrinking */
            }
        }

        #siteFrame {
            flex-grow: 1;
            border: none;
            width: 100%;
            height: 100%;
            background-color: #fff;
        }
    </style>
    <!-- Widget Loader Script (No type="module" so it runs immediately to inject importmap) -->
    <!-- Simple Script Include -->
    <script src="./avatar-widget.js"></script>
</head>

<body>
    <div id="toolbar">
        <div class="toolbar-group" id="url-group">
            <input type="url" id="urlInput" placeholder="Enter website URL (e.g., https://example.com)"
                value="https://voice.botnoi.ai/" />
            <button id="loadBtn">Load</button>
        </div>
        <div class="toolbar-group" id="select-group">
            <select id="modelSelect"></select>
            <select id="animSelect"></select>
        </div>
        <div class="toolbar-group" id="audio-group">
            <input type="text" id="audioInput" placeholder="Audio URL or Base64" style="width: 150px;">
            <button id="playAudioBtn">Play</button>
            <button id="stopAudioBtn">Stop</button>
            <label for="volumeSlider">Vol:</label>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="1" style="width: 60px;">
        </div>
        <div id="toolbar-notch" title="Toggle Toolbar">▲</div>
    </div>

    <iframe id="siteFrame" src="about:blank"></iframe>

    <script>
        const initWidget = async () => {
            // Determine size based on screen width
            const isMobile = window.innerWidth < 600;
            const widgetWidth = isMobile ? 200 : 300;
            const widgetHeight = isMobile ? 500 : 700;

            // Initialize Widget first
            const widget = new AvatarWidget({
                modelUrl: 'Kitagawa', // Default, resolved by manifest/logic
                animationUrl: 'Greeting',
                defaultAnimationUrl: 'Idleloop', // Default, resolved by manifest/logic
                width: widgetWidth,
                height: widgetHeight,
                position: 'bottom-right',
                onAnimationLoaded: (url) => {
                    const animSelect = document.getElementById('animSelect');
                    if (animSelect) {
                        // Check exact match or by filename
                        const filename = url.split('/').pop().toLowerCase();
                        for (let i = 0; i < animSelect.options.length; i++) {
                            const optVal = animSelect.options[i].value.toLowerCase();
                            // If selector has simple names, we check by simple name
                            if (url.endsWith(optVal) || optVal === filename) {
                                animSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }
                }
            });

            // Initialize to load manifest and dependencies
            await widget.init();

            // Populate Dropdowns from Widget Manifest
            const populateSelect = (selectId, assets, defaultName) => {
                const select = document.getElementById(selectId);
                select.innerHTML = '';
                let defaultValue = null;

                console.log(`Populating ${selectId} with ${assets.length} assets`);

                assets.forEach(fileName => {
                    const option = document.createElement('option');
                    option.value = fileName; // Simple filename, e.g. "Blossom.vrm"
                    option.textContent = fileName.replace(/\.[^/.]+$/, ""); // Remove extension
                    select.appendChild(option);

                    if (fileName.toLowerCase().includes(defaultName.toLowerCase())) {
                        defaultValue = fileName;
                        option.selected = true;
                    }
                });
                return defaultValue || (assets.length > 0 ? assets[0] : null);
            };

            const models = widget.getModels();
            const anims = widget.getAnimations();

            populateSelect('modelSelect', models, 'Kitagawa');
            populateSelect('animSelect', anims, 'Idleloop');

            // Expose to window for debugging and future interactions
            window.avatarWidget = widget;

            // Handle URL loading
            const urlInput = document.getElementById('urlInput');
            const loadBtn = document.getElementById('loadBtn');
            const siteFrame = document.getElementById('siteFrame');

            const loadSite = () => {
                let url = urlInput.value.trim();
                if (url) {
                    if (!url.startsWith('http://') && !url.startsWith('https://')) {
                        url = 'https://' + url;
                        urlInput.value = url;
                    }
                    siteFrame.src = url;
                }
            };

            loadBtn.addEventListener('click', loadSite);
            urlInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    loadSite();
                }
            });
            // loadBtn.click();

            // Model and Animation Switching
            const modelSelect = document.getElementById('modelSelect');
            const animSelect = document.getElementById('animSelect');

            modelSelect.addEventListener('change', (e) => {
                widget.loadModel(e.target.value);
            });

            animSelect.addEventListener('change', (e) => {
                widget.loadAnimation(e.target.value);
            });

            // Audio Controls
            const audioInput = document.getElementById('audioInput');
            const playAudioBtn = document.getElementById('playAudioBtn');
            const stopAudioBtn = document.getElementById('stopAudioBtn');
            const volumeSlider = document.getElementById('volumeSlider');

            playAudioBtn.addEventListener('click', () => {
                const source = audioInput.value.trim();
                if (source) {
                    widget.playAudio(source);
                } else {
                    alert('Please enter an Audio URL or Base64 string');
                }
            });

            stopAudioBtn.addEventListener('click', () => {
                widget.stopAudio();
            });

            volumeSlider.addEventListener('input', (e) => {
                widget.setVolume(parseFloat(e.target.value));
            });

            // Toolbar Collapse Logic
            const toolbar = document.getElementById('toolbar');
            const notch = document.getElementById('toolbar-notch');
            let isToolbarCollapsed = false;

            const updateToolbarState = () => {
                if (isToolbarCollapsed) {
                    const height = toolbar.offsetHeight;
                    toolbar.style.marginTop = `-${height}px`;
                    notch.textContent = '▼';
                } else {
                    toolbar.style.marginTop = '0px';
                    notch.textContent = '▲';
                }
            };

            notch.addEventListener('click', () => {
                isToolbarCollapsed = !isToolbarCollapsed;
                if (isToolbarCollapsed) {
                    toolbar.classList.add('collapsed');
                } else {
                    toolbar.classList.remove('collapsed');
                }
                updateToolbarState();
            });

            window.addEventListener('resize', () => {
                if (isToolbarCollapsed) {
                    updateToolbarState();
                }
            });
        };

        // Wait for DOM to be ready then init
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initWidget);
        } else {
            initWidget();
        }
    </script>
</body>

</html>